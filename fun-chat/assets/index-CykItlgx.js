(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class x{children=[];_subscriptions=[];get node(){return this._element}addClasses(e){e&&e.length>0&&this._element.classList.add(...e)}removeClasses(e){e&&e.length>0&&this._element.classList.remove(...e)}toggleClass(e){e&&this._element.classList.toggle(e)}setAttributes(e){if(e)for(const[t,s]of Object.entries(e))s&&this._element.setAttribute(t,s)}getAttribute(e){return this._element.getAttribute(e)}removeAttribute(e){this._element.removeAttribute(e)}appendChildren(...e){for(const t of e)t instanceof x?(this._element.append(t.node),this.children=[...this.children,t]):t instanceof Node&&this._element.append(t)}deleteChildren(){for(this.children.map(e=>{e.deleteElement()}),this.children=[];this._element.firstChild;)this._element.firstChild.remove()}deleteElement(){this.deleteChildren(),this.unsubscribeAll(),this._element.remove()}sub(...e){e.forEach(t=>{this._subscriptions.push(t)})}unsubscribeAll(){this._subscriptions.forEach(e=>{e()})}addListener(e,t){this._element.addEventListener(e,t)}removeListener(e,t){this._element.removeEventListener(e,t)}dispatchEvent(e,t){const s=new CustomEvent(e,{detail:t});this._element.dispatchEvent(s)}}class a extends x{_element;constructor(e){super(),this._element=document.createElement(e.tag),e&&(this.addClasses(e.classNames),this.setText(e.text),this.setAttributes(e.attributes))}setText(e){e&&(this._element.textContent=e)}}class P extends x{_element;constructor(e){super(),this._element=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.classNames&&this.addClasses(e.classNames),this.setAttributes(e.attributes);const t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttribute("href",e.href),this.appendChildren(t)}}const W="_footer_1by5p_1",X={footer:W};class Z extends a{constructor(){super({tag:"footer",classNames:[X.footer]}),this.render()}render(){const e=new a({tag:"a",attributes:{href:"https://rs.school/"}}),t=new P({href:"./rss.svg#rss",attributes:{width:"100",height:"36",fill:"black"}});e.appendChildren(t);const s=new a({tag:"a",attributes:{href:"https://github.com/YaroshenkoAnna"}}),i=new P({href:"./sprite.svg#git",attributes:{width:"36",height:"36",fill:"black"}});s.appendChildren(i);const n=new a({tag:"p",text:"2025 Â© Anna Yaroshenko"});this.appendChildren(e,n,s)}}const Q="_overlay_1yp9u_1",ee="_spinner_1yp9u_14",N={overlay:Q,spinner:ee};class te extends a{constructor(){super({tag:"div",classNames:[N.overlay]}),this.render()}render(){const e=new a({tag:"div",classNames:[N.spinner]}),t=new a({tag:"p",classNames:[N.text],text:"Connecting..."});this.appendChildren(e,t)}}const se="_button_oge0e_1",ie={button:se};class b extends a{constructor(e){super({tag:"button",classNames:[...e.classNames??[],ie.button],text:e.text,attributes:e.attributes}),this.addListener("click",e.callback)}disable(){this.setAttributes({disabled:"true"})}enable(){this.removeAttribute("disabled")}setDisabled(e){e?this.disable():this.enable()}}class ne{listeners=new Set;emit(e){for(const t of this.listeners)t(e)}subscribe(e){return this.listeners.add(e),this.unsubscribe.bind(this,e)}unsubscribe(e){this.listeners.delete(e)}}class m extends ne{constructor(e){super(),this._value=e}get value(){return this._value}set(e){this._value=e,this.emit(this._value)}update(e){this._value=e(this._value),this.emit(this._value)}subscribeAndGet(e){return e(this._value),this.subscribe(e)}}const re="_error_173rj_1",V={error:re,"error-message":"_error-message_173rj_8"};class T extends a{value$=new m("");errorMessage=new a({tag:"label",classNames:[V["error-message"]]});constructor(e){super({tag:"input",classNames:e.classNames,text:e.text,attributes:e.attributes}),this.setType(e.type),this.addListener("input",()=>{this.value$.set(this.value)})}get value(){return this._element.value}set value(e){this._element.value=e,this.value$.set(e)}disable(){this._element.setAttribute("disabled","true")}enable(){this._element.removeAttribute("disabled")}setType(e){this._element.setAttribute("type",e)}observe(e){return this.value$.subscribeAndGet(e)}showErrors(e){this.errorMessage.deleteElement(),this._element.classList.toggle(V.error,e.length>0),e.length>0&&(this._element.parentElement?.appendChild(this.errorMessage.node),this.errorMessage.setText(e.join(`
`)))}}const ae="_main_hrtj2_1",oe="_form_hrtj2_13",le="_fieldset_hrtj2_20",ce="_label_hrtj2_33",de="_input_hrtj2_26",g={main:ae,form:oe,fieldset:le,"input-container":"_input-container_hrtj2_26",label:ce,input:de,"error-label":"_error-label_hrtj2_41"};class he{routes;outlet;defaultRoute;errorRoute;constructor(e,t,s,i){this.routes=e,this.outlet=t,this.defaultRoute=s,this.errorRoute=i,globalThis.addEventListener("hashchange",()=>{this.loadRoute()}),globalThis.location.hash===""?this.navigate(this.defaultRoute):this.loadRoute()}async loadRoute(){const t=globalThis.location.hash.replace(/^#\/?/,"/"),s=this.routes.find(i=>i.path===t)||this.routes.find(i=>i.path===this.errorRoute);if(s){const i=await s.page(this);this.outlet.node.replaceChildren(i.node)}else console.error(`Route for path ${t} not found.`)}navigate(e,t=!1){const s=`#/${e.replace(/^\/+/,"")}`;if(t&&globalThis.location.hash!==s){const i=new URL(globalThis.location.href);i.hash=s,globalThis.location.replace(i.toString())}else globalThis.location.hash=s}}let S=null;function M(){if(!S)throw new Error("Router has not been initialized yet.");return S}function ue(o,e,t,s){return S=new he(o,e,t,s),S}class B extends a{formVM;loginVM;form=new a({tag:"form",classNames:[g.form]});fieldset=new a({tag:"fieldset",classNames:[g.fieldset]});legend=new a({tag:"legend",text:"Authorization"});loginContainer=new a({tag:"div",classNames:[g["input-container"]]});loginLabel=new a({tag:"label",classNames:[g.label],text:"Login"});passwordLabel=new a({tag:"label",classNames:[g.label],text:"Password"});passwordContainer=new a({tag:"div",classNames:[g["input-container"]]});loginInput=new T({type:"text",classNames:[g.input],attributes:{id:"name",placeholder:"Enter your name"}});passwordInput=new T({type:"password",classNames:[g.input],attributes:{id:"password",placeholder:"Enter password"}});submitButton=new b({text:"Submit",attributes:{type:"submit"},callback:e=>{e.preventDefault(),this.onSubmit()}});infoButton=new b({text:"Info",callback:()=>{M().navigate("/info")}});errorLabel=new a({tag:"label",classNames:[g["error-label"]],text:""});constructor(e,t){super({tag:"main",classNames:[g.main]}),this.formVM=t,this.loginVM=e,this.render(),this.bind(),this.loginInput.addListener("input",()=>{this.errorLabel.deleteElement()}),this.passwordInput.addListener("input",()=>{this.errorLabel.deleteElement()})}render(){this.appendChildren(this.form),this.form.appendChildren(this.fieldset,this.submitButton,this.infoButton),this.fieldset.appendChildren(this.legend,this.loginContainer,this.passwordContainer),this.loginContainer.appendChildren(this.loginLabel,this.loginInput),this.passwordContainer.appendChildren(this.passwordLabel,this.passwordInput)}bind(){this.formVM.isFormValid$.subscribe(e=>{this.submitButton.setDisabled?.(!e)}),this.loginInput.observe(e=>{this.formVM.setLogin(e),this.loginInput.showErrors(this.formVM.getLoginErrors())}),this.passwordInput.observe(e=>{this.formVM.setPassword(e),this.passwordInput.showErrors(this.formVM.getPasswordErrors())})}async onSubmit(){const e=await this.loginVM.submit(this.loginInput.value,this.passwordInput.value);e?(this.errorLabel.setText(e),this.fieldset.appendChildren(this.errorLabel)):this.errorLabel.deleteElement()}}const ge="_main_br4ga_1",me="_header_br4ga_10",pe="_contacts_br4ga_21",fe="_dialog_br4ga_22",be="_content_br4ga_33",ve="_list_br4ga_79",_e="_title_br4ga_96",h={main:ge,header:me,contacts:pe,dialog:fe,content:be,"dialog-input":"_dialog-input_br4ga_48","message-input":"_message-input_br4ga_55","dialog-header":"_dialog-header_br4ga_60","dialog-body":"_dialog-body_br4ga_69",list:ve,"buttons-container":"_buttons-container_br4ga_85","current-user":"_current-user_br4ga_92",title:_e},we="_contact_asv6y_1",Ce="_login_asv6y_7",Le="_container_asv6y_11",Ue="_status_asv6y_17",Ee="_message_asv6y_23",C={contact:we,login:Ce,container:Le,status:Ue,message:Ee};var E=(o=>(o.Online="Online",o.Offline="Offline",o))(E||{}),H=(o=>(o.Online="green",o.Offline="red",o))(H||{});class D extends a{constructor(e,t,s,i){super({tag:"li",classNames:[C.contact]}),this.render(e,t,s,i)}render(e,t,s,i){const n=new a({tag:"label",classNames:[C.login],text:e}),r=new a({tag:"div",classNames:[C.container]}),l=new a({tag:"span",classNames:[C.status],attributes:{style:`background-color: ${H[t]}`}}),c=new a({tag:"span",classNames:[C.message],text:s>0?String(s):""});this.appendChildren(r,c),r.appendChildren(l,n),r.addListener("click",()=>{i()})}}class ye{messages={};unreadCounts={};currentUserLogin="";setCurrentUserLogin(e){this.currentUserLogin=e}getCurrentUserLogin(){return this.currentUserLogin}getMessages$(e){return this.messages[e]||(this.messages[e]=new m([])),this.messages[e]}setMessages(e,t){this.getMessages$(e).set(t),t.some(i=>i.to===this.currentUserLogin)&&this.updateUnreadCount(e)}addMessage(e,t){const s=this.getMessages$(e).value;this.getMessages$(e).set([...s,t]),t.to===this.currentUserLogin&&this.updateUnreadCount(t.from)}updateStatus(e,t){for(const s in this.messages){const i=this.messages[s].value,n=i.findIndex(r=>r.id===e);if(n!==-1){const r=[...i];r[n]={...r[n],status:{...r[n].status,...t}},this.messages[s].set(r),this.updateUnreadCount(s);return}}}updateText(e,t,s){for(const i in this.messages){const n=this.messages[i].value,r=n.findIndex(l=>l.id===e);if(r!==-1){const l=[...n];l[r]={...l[r],text:t,status:{...l[r].status,...s}},this.messages[i].set(l),this.updateUnreadCount(i);return}}}getUnreadCount$(e){return this.unreadCounts[e]||(this.unreadCounts[e]=new m(0)),this.unreadCounts[e]}updateUnreadCount(e){const s=this.getMessages$(e).value.filter(i=>!i.status.isReaded&&i.from===e&&i.to===this.currentUserLogin).length;this.getUnreadCount$(e).set(s)}removeMessage(e){for(const t in this.messages){const s=this.messages[t].value,i=s.findIndex(n=>n.id===e);if(i!==-1){const n=[...s];n.splice(i,1),this.messages[t].set(n),this.updateUnreadCount(t);return}}}}const u=new ye,Se="_list_1tqyc_1",$e="_divider_1tqyc_10",j={list:Se,divider:$e},xe="_message_ojohq_1",Me="_own_ojohq_10",Ie="_text_ojohq_15",Ne="_info_ojohq_21",Re="_status_ojohq_28",Ae="_controls_ojohq_36",Te="_button_ojohq_42",Oe="_foreign_ojohq_59",p={message:xe,own:Me,text:Ie,info:Ne,status:Re,controls:Ae,button:Te,foreign:Oe};let y=null;function ke(o){y&&y!==o&&y.deactivate(),y=o}class Pe extends a{modal=null;controls;isControlsVisible=!1;constructor(e,t,s,i){super({tag:"li",classNames:[p.message]});const n=new Date(e.datetime).toLocaleTimeString(),r=e.from===t;this.addClasses(r?[p.own]:[p.foreign]);const l=new a({tag:"div",classNames:[p.text],text:e.text}),c=new a({tag:"div",classNames:[p.info],text:`${e.from} â€¢ ${n}${e.status.isEdited?" â€¢ edited":""}`}),_=new a({tag:"span",classNames:[p.status],text:r?e.status.isReaded?"âœ“âœ“":e.status.isDelivered?"âœ“":"":""});if(this.controls=new a({tag:"div",classNames:[p.controls]}),r){const w=new b({text:"âœï¸",classNames:[p.button],callback:()=>{s?.(e.id,e.text),this.hideControls()}}),I=new b({text:"ðŸ—‘ï¸",classNames:[p.button],callback:()=>{i?.(e.id),this.hideControls()}});this.controls.appendChildren(w,I)}this.addListener("click",w=>{w.stopPropagation(),ke(this),this.toggleControls()}),document.addEventListener("click",()=>this.hideControls()),this.appendChildren(c,_,l)}deactivate(){this.hideControls(),this.modal?.deleteElement()}toggleControls(){this.isControlsVisible?this.hideControls():this.showControls()}showControls(){this.isControlsVisible||(this.appendChildren(this.controls),this.isControlsVisible=!0)}hideControls(){this.isControlsVisible&&(this.controls.deleteElement(),this.modal?.deleteElement(),this.isControlsVisible=!1)}}class Ve extends a{constructor(e,t,s=null,i,n){super({tag:"ul",classNames:[j.list]}),this.render(e,t,s,i,n)}render(e,t,s,i,n){if(!e.length){this.appendChildren(new a({tag:"div",text:"This is the beginning of your conversation."}));return}e.forEach((r,l)=>{s!==null&&l===s&&this.appendChildren(new a({tag:"hr",classNames:[j.divider]})),this.appendChildren(new Pe(r,t,i,n))}),setTimeout(()=>{this.node.scrollTop=this.node.scrollHeight},0)}}class G extends a{header=new a({tag:"section",classNames:[h.header]});content=new a({tag:"section",classNames:[h.content]});contacts=new a({tag:"aside",classNames:[h.contacts]});dialog=new a({tag:"section",classNames:[h.dialog]});currentUser=new a({tag:"label",classNames:[h["current-user"]]});title=new a({tag:"h1",classNames:[h.title],text:"Fun Chat"});buttonsContainer=new a({tag:"div",classNames:[h["buttons-container"]]});infoButton=new b({text:"Info",classNames:[h.button],callback:()=>{M().navigate("/info")}});logoutButton;search=new T({type:"text",classNames:[h.search],attributes:{placeholder:"Search"}});usersList=new a({tag:"ul",classNames:[h.list]});dialogHeader=new a({tag:"div",classNames:[h["dialog-header"]]});dialogBody=new a({tag:"div",classNames:[h["dialog-body"]]});dialogInput=new a({tag:"form",classNames:[h["dialog-input"]]});selectedUser=new a({tag:"label",text:"Selected user"});status=new a({tag:"label",text:"Status"});info=new a({tag:"label",text:"Choose user to start chat",classNames:[h.info]});messageInput=new a({tag:"textarea",classNames:[h["message-input"]],attributes:{placeholder:"Type your message"}});sendButton=new b({text:"Send",attributes:{type:"submit"},callback:e=>{e.preventDefault(),this.sendMessage()}});isDestroyed=!1;subscriptions=[];selectedLogin=null;userStore;messageService;currentUserLogin;unreadSubscriptions={};editingMessageId=null;constructor(e,t,s){super({tag:"main",classNames:[h.main]}),this.logoutButton=new b({text:"Logout",classNames:[h.button],callback:()=>{this.destroy(),t.logout()}}),this.userStore=e;const i=this.userStore.currentUser$?.value;i?.login&&u.setCurrentUserLogin(i.login),this.initSubscriptions(),this.currentUser.setText(`User: ${this.userStore?.currentUser$?.value?.login}`),this.messageService=s,this.currentUserLogin=i?.login??"",this.render(),this.renderContacts(this.userStore.activeUsers$.value,this.userStore.inactiveUsers$.value)}render(){this.messageInput.setAttributes({disabled:"true"}),this.sendButton.setAttributes({disabled:"true"}),this.appendChildren(this.header,this.content),this.content.appendChildren(this.contacts,this.dialog),this.header.appendChildren(this.currentUser,this.title,this.buttonsContainer),this.buttonsContainer.appendChildren(this.infoButton,this.logoutButton),this.contacts.appendChildren(this.search,this.usersList),this.dialog.appendChildren(this.dialogHeader,this.dialogBody,this.dialogInput),this.dialogHeader.appendChildren(this.selectedUser,this.status),this.dialogBody.appendChildren(this.info),this.dialogInput.appendChildren(this.messageInput,this.sendButton),this.messageInput.addListener("keydown",e=>{if(this.messageInput.node.value.length===0){this.sendButton.setAttributes({disabled:"true"});return}this.sendButton.removeAttribute("disabled"),e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}),this.search.addListener("input",e=>{const t=e.target.value;this.userStore.filter(t)})}renderContacts(e,t){for(const r of Object.values(this.unreadSubscriptions))r();this.unreadSubscriptions={},this.usersList.deleteChildren();const s=(r,l)=>{const c=u.getUnreadCount$(r.login);let _=new D(r.login,l,c.value,()=>this.selectUser(r,l));this.usersList.appendChildren(_);const w=c.subscribe(I=>{const O=new D(r.login,l,I,()=>this.selectUser(r,l)),k=Array.from(this.usersList.node.children).indexOf(_.node);k!==-1&&(this.usersList.node.children[k].replaceWith(O.node),_=O)});this.unreadSubscriptions[r.login]=w};e.forEach(r=>s(r,E.Online)),t.forEach(r=>s(r,E.Offline));const n=[...e,...t].find(r=>r.login===this.selectedLogin);if(n){const r=e.includes(n)?E.Online:E.Offline;this.status.setText(`Status: ${r}`)}}selectedMessagesSubscription=null;selectUser(e,t){this.messageInput.removeAttribute("disabled"),this.selectedLogin=e.login,this.selectedUser.setText(`Selected: ${e.login}`),this.status.setText(`Status: ${t}`),this.selectedMessagesSubscription&&this.selectedMessagesSubscription();const s=u.getMessages$(e.login);this.selectedMessagesSubscription=s.subscribe(i=>{this.updateMessages(i)}),s.value.length===0?this.messageService.fetchHistory(e.login):this.updateMessages(s.value)}updateMessages(e){this.dialogBody.deleteChildren();const t=e.findIndex(i=>i.to===this.currentUserLogin&&!i.status.isReaded),s=new Ve(e,this.currentUserLogin,t>=0?t:null,this.editMessage.bind(this),this.deleteMessage.bind(this));t>=0&&e.slice(t).forEach(n=>{!n.status.isReaded&&n.to===this.currentUserLogin&&this.messageService.markAsRead(n.id)}),this.dialogBody.appendChildren(s)}sendMessage(){const e=this.messageInput.node.value.trim();if(!this.selectedLogin||!e)return;if(this.editingMessageId){this.messageService.editMessage(this.editingMessageId,e).then(()=>{this.editingMessageId=null,this.sendButton.setText("Send"),this.messageInput.node.value=""});return}const t={id:`temp-${Date.now()}`,from:this.currentUserLogin,to:this.selectedLogin,text:e,datetime:Date.now(),status:{isDelivered:!1,isReaded:!1,isEdited:!1,isDeleted:!1}};u.addMessage(this.selectedLogin,t),this.messageService.send(this.selectedLogin,e).then(()=>{this.messageInput.node.value=""}),this.sendButton.setAttributes({disabled:"true"})}editMessage(e,t){this.messageInput.setText(""),this.editingMessageId=e,this.messageInput.node.value=t,this.sendButton.setText("Edit")}deleteMessage(e){this.messageService.deleteMessage(e).then(()=>{u.removeMessage(e)})}initSubscriptions(){const e=()=>{if(this.isDestroyed)return;const i=this.userStore.activeUsers$.value,n=this.userStore.inactiveUsers$.value;this.renderContacts(i,n),[...i,...n].forEach(l=>{this.messageService.fetchHistory(l.login)})},t=this.userStore.activeUsers$.subscribe(e),s=this.userStore.inactiveUsers$.subscribe(e);this.subscriptions.push(t,s)}destroy(){this.isDestroyed=!0,this.subscriptions.forEach(e=>e()),this.subscriptions=[];for(const e of Object.values(this.unreadSubscriptions))e();this.unreadSubscriptions={},this.selectedMessagesSubscription&&(this.selectedMessagesSubscription(),this.selectedMessagesSubscription=null)}}const Be="_main_f4n5n_1",De="_title_f4n5n_12",L={main:Be,title:De};class je extends a{defaultRoute;constructor(e){super({tag:"main",classNames:[L.main]}),this.defaultRoute=e,this.render()}render(){const e=new a({tag:"h1",classNames:[L.title],text:"Fun Chat"}),t=new a({tag:"p",classNames:[L.paragraph],text:"Fun Chat is a chat application that allows you to communicate with your friends and family in real-time."}),s=new a({tag:"a",classNames:[L.link],text:"Author Anna Yaroshenko",attributes:{href:"https://github.com/YaroshenkoAnna"}}),i=new b({text:"Return",classNames:[L.button],callback:()=>{M().navigate(this.defaultRoute)}});this.appendChildren(e,t,s,i)}}const Ge="_image_5475x_1",qe={image:Ge};class Fe extends a{constructor(){super({tag:"main"}),this.render()}render(){const e=new a({tag:"img",classNames:[qe.image],attributes:{src:"./error.png",alt:"error image"}});this.appendChildren(e)}}const He="ws://localhost:4000";class ze{constructor(e=He){this.url=e,this.connect()}socket=null;isConnected$=new m(!1);messageListeners=new Map;connect(){this.socket=new WebSocket(this.url),this.socket.addEventListener("open",()=>{this.isConnected$.set(!0)}),this.socket.addEventListener("close",()=>{this.isConnected$.set(!1),setTimeout(()=>this.connect(),5e3)}),this.socket.addEventListener("error",e=>{console.error("WebSocket error:",e)}),this.socket.addEventListener("message",e=>{const t=JSON.parse(e.data);this.messageListeners.get(t.type)?.forEach(s=>s(t))})}send(e){this.socket?.send(JSON.stringify(e))}on(e,t){return this.messageListeners.has(e)||this.messageListeners.set(e,[]),this.messageListeners.get(e).push(t),()=>{const s=this.messageListeners.get(e);this.messageListeners.set(e,s.filter(i=>i!==t))}}}function f(){return self.crypto.randomUUID()}class Ye{constructor(e){this.client=e}login(e,t){return new Promise((s,i)=>{const n=f(),r=this.client.on("USER_LOGIN",c=>{c.id===n&&(r(),s(c.payload.user))}),l=this.client.on("ERROR",c=>{c.id===n&&(l(),i(c.payload.error))});this.client.send({id:n,type:"USER_LOGIN",payload:{user:{login:e,password:t}}})})}logout(e,t){return new Promise((s,i)=>{const n=f(),r=this.client.on("USER_LOGOUT",c=>{c.id===n&&(r(),s(c.payload.user))}),l=this.client.on("ERROR",c=>{c.id===n&&(l(),i(c.payload.error))});this.client.send({id:n,type:"USER_LOGOUT",payload:{user:{login:e,password:t}}})})}}class Je{passwordErrors=[];loginErrors=[];validateForm(e,t){return this.validateLogin(e)&&this.validatePassword(t)}validatePassword(e){this.passwordErrors=[];const t=6,s=20,i=/[A-Z]/.test(e),n=/[a-z]/.test(e),r=/\d/.test(e),l=[{condition:e.length<t,message:`Password must be at least ${t} characters.`},{condition:e.length>s,message:`Password must be no more than ${s} characters.`},{condition:!n||!i||!r,message:"Password must contain at least one uppercase, one lowercase letter  and one number."}];for(const c of l)c.condition&&this.passwordErrors.push(c.message);return this.passwordErrors.length===0}validateLogin(e){this.loginErrors=[];const t=4,s=15;return e.length<t&&this.loginErrors.push(`Login must be at least ${t} characters.`),e.length>s&&this.loginErrors.push(`Login must be no more than ${s} characters.`),this.loginErrors.length===0}}class Ke{login$=new m("");password$=new m("");isFormValid$=new m(!1);validator=new Je;constructor(){this.login$.subscribe(()=>this.validate()),this.password$.subscribe(()=>this.validate())}setLogin(e){this.login$.set(e)}setPassword(e){this.password$.set(e)}getLoginErrors(){return this.validator.validateLogin(this.login$.value),this.validator.loginErrors}getPasswordErrors(){return this.validator.validatePassword(this.password$.value),this.validator.passwordErrors}validate(){const e=this.validator.validateForm(this.login$.value,this.password$.value);this.isFormValid$.set(e)}}class We{constructor(e){this.storage=e}get(e){const t=this.storage.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}set(e,t){this.storage.setItem(e,JSON.stringify(t))}remove(e){this.storage.removeItem(e)}}const R="user",A="userPass";class Xe{password=null;currentUser$=new m(null);activeUsers$=new m([]);inactiveUsers$=new m([]);allActiveUsers=[];allInactiveUsers=[];storage;constructor(e){this.storage=e;const t=this.storage.get(R);this.password=this.storage.get(A)??null,t?.isLogined&&this.currentUser$.set(t)}setUser(e,t){this.currentUser$.set(e),this.password=t,this.storage.set(R,e),this.storage.set(A,t)}get isAuthenticated(){return!!this.currentUser$.value?.isLogined}setActive(e){this.allActiveUsers=e,this.activeUsers$.set(this.excludeCurrentUser(e))}setInactive(e){this.allInactiveUsers=e,this.inactiveUsers$.set(this.excludeCurrentUser(e))}clearAll(){this.activeUsers$.set([]),this.inactiveUsers$.set([]),this.currentUser$.set(null),this.password=null,this.storage.remove(R),this.storage.remove(A)}filter(e){this.activeUsers$.set(this.excludeCurrentUser(this.allActiveUsers)),this.inactiveUsers$.set(this.excludeCurrentUser(this.allInactiveUsers));const t=this.excludeCurrentUser(this.allActiveUsers.filter(i=>i.login.toLowerCase().includes(e.toLowerCase()))),s=this.excludeCurrentUser(this.allInactiveUsers.filter(i=>i.login.toLowerCase().includes(e.toLowerCase())));this.activeUsers$.set(t),this.inactiveUsers$.set(s)}excludeCurrentUser(e){const t=this.currentUser$.value;return t?e.filter(s=>s.login!==t.login):e}initializeUsers(e){if(!this.currentUser$.value)return;const s=e.filter(n=>n.isLogined),i=e.filter(n=>!n.isLogined);this.allActiveUsers=s,this.allInactiveUsers=i,this.setActive(s),this.setInactive(i)}}const Ze=new We(sessionStorage),d=new Xe(Ze);class Qe{constructor(e){this.authService=e}router=null;async submit(e,t){try{const s=await this.authService.login(e,t);return s.isLogined&&this.router?(d.setUser(s,t),K?.fetchAll(),this.router.navigate("/main"),null):"unexpected error"}catch(s){const i=typeof s=="string"?s:typeof s=="object"&&s!==null&&"message"in s?String(s.message):"";switch(i){case"a user with this login is already authorized":return"a user is already authorized";case"another user is already authorized in this connection":return"first logout from another user";case"incorrect password":return"Incorrect password";default:return"Error: "+i}}}setRouter(e){this.router=e}logout(){const e=d.currentUser$.value;e&&d.password&&this.authService.logout(e.login,d.password).then(()=>{d.clearAll(),M().navigate("/login")})}}const z="/login",et="/error",tt="_container_i7vp2_17",st={container:tt};class it{constructor(e){this.client=e,this.subscribeToExternalChanges(),this.fetchAll()}async fetchAll(){const[e,t]=await Promise.all([this.fetchUsers("USER_ACTIVE"),this.fetchUsers("USER_INACTIVE")]);d.setActive(e),d.setInactive(t)}fetchActiveUsers(){return this.fetchUsers("USER_ACTIVE")}fetchInactiveUsers(){return this.fetchUsers("USER_INACTIVE")}fetchUsers(e){return new Promise((t,s)=>{const i=f(),n=this.client.on(e,l=>{l.id===i&&(n(),t(l.payload.users))}),r=this.client.on("ERROR",l=>{l.id===i&&(r(),s(l.payload.error))});this.client.send({id:i,type:e,payload:null})})}subscribeToExternalChanges(){this.client.on("USER_EXTERNAL_LOGIN",e=>{const t=e.payload.user;if(t.isLogined){const s=d.activeUsers$.value,i=d.inactiveUsers$.value;s.some(l=>l.login===t.login)||d.setActive([...s,t]);const r=i.filter(l=>l.login!==t.login);r.length!==i.length&&d.setInactive(r)}}),this.client.on("USER_EXTERNAL_LOGOUT",e=>{const t=e.payload.user,s=d.activeUsers$.value.filter(r=>r.login!==t.login);d.setActive(s);const i=d.inactiveUsers$.value;i.some(r=>r.login===t.login)||d.setInactive([...i,t])})}}class nt{constructor(e){this.client=e,this.subscribeToMessages()}send(e,t){const s=f();return this.sendRequest("MSG_SEND",{message:{to:e,text:t}},s).then(i=>(this.fetchHistory(e),i))}fetchHistory(e){const t=f();return this.sendRequest("MSG_FROM_USER",{user:{login:e}},t).then(s=>(u.setMessages(e,s.messages),u.updateUnreadCount(e),s.messages))}markAsRead(e){const t=f();return this.sendRequest("MSG_READ",{message:{id:e}},t).then(()=>{})}deleteMessage(e){const t=f();return this.sendRequest("MSG_DELETE",{message:{id:e}},t).then(()=>{})}editMessage(e,t){const s=f();return this.sendRequest("MSG_EDIT",{message:{id:e,text:t}},s).then(()=>{})}subscribeToMessages(){this.client.on("MSG_SEND",e=>{const t=e.payload.message;u.addMessage(t.from,t)}),this.client.on("MSG_DELIVER",e=>{u.updateStatus(e.payload.message.id,{isDelivered:!0})}),this.client.on("MSG_READ",e=>{u.updateStatus(e.payload.message.id,{isReaded:!0})}),this.client.on("MSG_DELETE",e=>{const t=e.payload.message.id;u.removeMessage(t)}),this.client.on("MSG_EDIT",e=>{const{id:t,text:s,status:i}=e.payload.message;u.updateText(t,s,i)})}sendRequest(e,t,s){return new Promise((i,n)=>{const r=this.client.on(e,c=>{c.id===s&&(r(),i(c.payload))}),l=this.client.on("ERROR",c=>{c.id===s&&(l(),n(c.payload.error))});this.client.send({id:s,type:e,payload:t})})}}const Y=new a({tag:"div",classNames:[st.container]});document.body.append(Y.node,new Z().node);const $=new ze,J=new Ye($);let K=null;const q=new Ke,U=new Qe(J),F=new nt($),rt=[{path:"/login",page:async o=>d.isAuthenticated?(o.navigate("/main",!0),new G(d,U,F)):(U.setRouter(o),new B(U,q))},{path:"/main",page:async o=>d.isAuthenticated?await new G(d,U,F):(o.navigate("/login",!0),new B(U,q))},{path:"/info",page:()=>Promise.resolve(new je(z))},{path:"/error",page:()=>Promise.resolve(new Fe)}];ue(rt,Y,z,et);let v=null;$.isConnected$.subscribeAndGet(o=>{!o&&!v?(v=new te,document.body.append(v.node)):o&&v&&(v.deleteElement(),v=null,K=new it($),d.isAuthenticated&&d.password&&J.login(d.currentUser$.value.login,d.password).catch(console.error))});
